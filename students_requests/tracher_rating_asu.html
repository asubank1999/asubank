<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Rating System</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #22c55e;
      --accent-dark: #15803d;
      --yellow: #eab308;
      --red: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }
    p.info {
      text-align: center;
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 1rem;
    }
    .card {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      padding: 20px;
      margin-bottom: 20px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: #0b1220;
      color: var(--text);
      font-size: 1rem;
    }
    input[type="range"] {
      width: 100%;
      margin-top: 8px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(180deg, var(--accent), var(--accent-dark));
      transition: transform 0.1s ease;
    }
    .btn.secondary {
      background: linear-gradient(180deg, #334155, #1e293b);
    }
    .btn:active {
      transform: scale(0.97);
    }
    #status {
      text-align: center;
      margin-top: 10px;
      color: var(--muted);
    }
    .teacher-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }
    .teacher-item {
      background: #0b1220;
      border-radius: 10px;
      padding: 10px 12px;
    }
    .teacher-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .rating-bar {
      height: 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      overflow: hidden;
      margin-top: 6px;
    }
    .rating-fill {
      height: 100%;
      border-radius: 8px;
      width: 0%;
      transition: width 0.6s ease;
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5rem; }
      .card { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Teacher Rating System</h1>
    <p class="info">Rate teachers anonymously and help others choose wisely. Click "Search" to view current ratings.</p>

    <div class="card">
      <label>Teacher Name</label>
      <input id="teacherName" type="text" placeholder="Dr. Ahmed or د. أحمد" />

      <label>Rating: <span id="ratingValue">5</span>/10</label>
      <input id="ratingRange" type="range" min="1" max="10" value="5" />

      <div class="row">
        <button class="btn" id="rateBtn">Submit</button>
        <button class="btn secondary" id="searchBtn">Search</button>
      </div>

      <div id="status"></div>
    </div>

    <div class="card">
      <h3>Rated Teachers</h3>
      <div id="teacherList" class="teacher-list"></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwdw7QBPLeBz1X-xBP6JeZEF5t7i4Ru1VfWshVqanRKd6xN0J2gQqvvovnTrYI_bpKt/exec";

    // === ELEMENTS ===
    const el = id => document.getElementById(id);
    const teacherName = el("teacherName");
    const ratingRange = el("ratingRange");
    const ratingValue = el("ratingValue");
    const teacherList = el("teacherList");
    const statusEl = el("status");

    ratingRange.addEventListener("input", () => {
      ratingValue.textContent = ratingRange.value;
    });

    el("rateBtn").addEventListener("click", () => {
      const name = teacherName.value.trim();
      const rating = parseInt(ratingRange.value);
      if (!name) return setStatus("Enter a teacher name first.", "error");
      addRating(name, rating);
    });

    el("searchBtn").addEventListener("click", refreshList);

    // === JSONP HELPERS ===
    function jsonp(url, callback) {
      const cbName = "cb_" + Math.random().toString(36).substr(2);
      window[cbName] = data => {
        callback(data);
        delete window[cbName];
        script.remove();
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cbName;
      script.onerror = () => setStatus("Failed to connect to server.", "error");
      document.body.appendChild(script);
    }

    function addRating(name, rating) {
      setStatus("Saving...");
      const url = `${BACKEND_URL}?action=addRating&teacher=${encodeURIComponent(name)}&rating=${rating}`;
      jsonp(url, res => {
        if (res && !res.error) {
          setStatus("Rating saved successfully!");
          teacherName.value = "";
          refreshList();
        } else {
          setStatus("Error saving rating.", "error");
        }
      });
    }

    function refreshList() {
      setStatus("Loading...");
      const url = `${BACKEND_URL}?action=listTeachers`;
      jsonp(url, res => {
        if (res && res.items) {
          renderList(res.items);
          setStatus("");
        } else {
          setStatus("Could not fetch data.", "error");
        }
      });
    }

    function renderList(items) {
      teacherList.innerHTML = "";
      if (!items.length) {
        teacherList.innerHTML = `<div style="color:var(--muted);text-align:center;">No teachers rated yet.</div>`;
        return;
      }
      for (const t of items) {
        const percent = (t.average / 10) * 100;
        let color = "var(--accent)";
        if (t.average <= 3) color = "var(--red)";
        else if (t.average <= 6) color = "var(--yellow)";

        const div = document.createElement("div");
        div.className = "teacher-item";
        div.innerHTML = `
          <div class="teacher-header">
            <strong>${t.display}</strong>
            <span>${t.average.toFixed(1)} / 10</span>
          </div>
          <div class="rating-bar">
            <div class="rating-fill" style="width:${percent}%;background:${color};"></div>
          </div>
        `;
        teacherList.appendChild(div);
      }
    }

    function setStatus(msg, type="info") {
      const colors = { info: "#94a3b8", error: "#ef4444" };
      statusEl.style.color = colors[type];
      statusEl.textContent = msg;
    }

    // Load list on page open
    refreshList();
  </script>
</body>
</html>
